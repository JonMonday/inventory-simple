generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum AssignmentMode {
  AUTO_POOL
  MANUAL_FROM_POOL
  SPECIFIC_USERS
}

enum AssignmentType {
  POOL
  USER
}

enum AssignmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model Department {
  id            String                 @id @default(uuid())
  code          String                 @unique
  name          String
  description   String?
  isActive      Boolean                @default(true)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  branchId      String
  branch        Branch                 @relation(fields: [branchId], references: [id])
  requests      Request[]
  workflowSteps TemplateWorkflowStep[]
  units         Unit[]
  users         User[]

  @@index([branchId])
  @@map("departments")
}

model Unit {
  id            String                 @id @default(uuid())
  code          String                 @unique
  name          String
  description   String?
  departmentId  String
  isActive      Boolean                @default(true)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  jobRoles      JobRole[]
  requests      Request[]
  workflowSteps TemplateWorkflowStep[]
  department    Department             @relation(fields: [departmentId], references: [id])
  users         User[]

  @@index([departmentId])
  @@map("units")
}

model JobRole {
  id            String                 @id @default(uuid())
  code          String                 @unique
  name          String
  description   String?
  unitId        String
  isActive      Boolean                @default(true)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  permissions   JobRolePermission[]
  unit          Unit                   @relation(fields: [unitId], references: [id])
  workflowSteps TemplateWorkflowStep[]
  users         User[]

  @@index([unitId])
  @@map("job_roles")
}

model JobRolePermission {
  jobRoleId    String
  permissionId String
  jobRole      JobRole    @relation(fields: [jobRoleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([jobRoleId, permissionId])
  @@map("job_role_permissions")
}

model Branch {
  id             String          @id @default(uuid())
  code           String          @unique
  name           String
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  departments    Department[]
  storeLocations StoreLocation[]
  users          User[]
  workflowSteps  TemplateWorkflowStep[]

  @@map("branches")
}

model StoreLocation {
  id                String            @id @default(uuid())
  code              String            @unique
  name              String
  branchId          String
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  forecastResults   ForecastResult[]
  ledgerEntriesFrom InventoryLedger[] @relation("FromStoreLocation")
  ledgerEntriesTo   InventoryLedger[] @relation("ToStoreLocation")
  requests          Request[]
  stockSnapshots    StockSnapshot[]
  stocktakes        Stocktake[]
  branch            Branch            @relation(fields: [branchId], references: [id])
  users             User[]

  @@index([branchId])
  @@map("store_locations")
}

model RequestStatus {
  id          String         @id @default(uuid())
  code        String         @unique
  label       String
  description String?
  isEditable  Boolean        @default(false)
  isTerminal  Boolean        @default(false)
  sortOrder   Int
  eventsFrom  RequestEvent[] @relation("FromStatus")
  eventsTo    RequestEvent[] @relation("ToStatus")
  requests    Request[]

  @@map("request_statuses")
}

model RequestStageType {
  id            String                 @id @default(uuid())
  code          String                 @unique
  label         String
  description   String?
  sortOrder     Int
  assignments   RequestAssignment[]
  comments      RequestComment[]
  eventsFrom    RequestEvent[]         @relation("FromStage")
  eventsTo      RequestEvent[]         @relation("ToStage")
  requests      Request[]
  workflowSteps TemplateWorkflowStep[]

  @@map("request_stage_types")
}

model RequestEventType {
  id          String         @id @default(uuid())
  code        String         @unique
  label       String
  description String?
  events      RequestEvent[]

  @@map("request_event_types")
}

model CommentType {
  id          String           @id @default(uuid())
  code        String           @unique
  label       String
  description String?
  comments    RequestComment[]

  @@map("comment_types")
}

model ParticipantRoleType {
  id           String               @id @default(uuid())
  code         String               @unique
  label        String
  description  String?
  participants RequestParticipant[]

  @@map("participant_role_types")
}

model LedgerMovementType {
  id            String                   @id @default(uuid())
  code          String                   @unique
  label         String
  description   String?
  ledgerEntries InventoryLedger[]
  reasonCodes   ReasonCodeMovementType[]

  @@map("ledger_movement_types")
}

model StocktakeStatus {
  id         String      @id @default(uuid())
  code       String      @unique
  label      String
  sortOrder  Int
  stocktakes Stocktake[]

  @@map("stocktake_statuses")
}

model ItemStatus {
  id          String  @id @default(uuid())
  code        String  @unique
  label       String
  description String?
  items       Item[]

  @@map("item_statuses")
}

model User {
  id                     String               @id @default(uuid())
  email                  String               @unique
  passwordHash           String
  fullName               String
  branchId               String
  departmentId           String
  unitId                 String
  jobRoleId              String
  primaryStoreLocationId String?
  mustChangePassword     Boolean              @default(false)
  isActive               Boolean              @default(true)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  auditLogs              AuditLog[]
  brandingUpdates        BrandingSettings[]
  createdForecastRuns    ForecastRun[]
  createdImportJobs      ImportJob[]
  createdLedgers         InventoryLedger[]    @relation("CreatedBy")
  assignmentsGiven       RequestAssignment[]  @relation("AssignedBy")
  assignmentsReceived    RequestAssignment[]  @relation("AssignedTo")
  requestComments        RequestComment[]
  requestEvents          RequestEvent[]
  participatedRequests   RequestParticipant[]
  templatesCreated       RequestTemplate[]
  requestsCreated        Request[]            @relation("Requester")
  approvedStocktakes     Stocktake[]          @relation("StocktakeApprover")
  createdStocktakes      Stocktake[]
  permissions            UserPermission[]
  roles                  UserRole[]
  branch                 Branch               @relation(fields: [branchId], references: [id])
  department             Department           @relation(fields: [departmentId], references: [id])
  jobRole                JobRole              @relation(fields: [jobRoleId], references: [id])
  primaryStoreLocation   StoreLocation?       @relation(fields: [primaryStoreLocationId], references: [id])
  unit                   Unit                 @relation(fields: [unitId], references: [id])
  specificStepAssignments TemplateStepSpecificUser[]

  @@index([branchId])
  @@index([departmentId])
  @@index([unitId])
  @@index([jobRoleId])
  @@map("users")
}

model Role {
  id           String           @id @default(uuid())
  code         String           @unique
  name         String           @unique
  description  String?
  isSystemRole Boolean          @default(false)
  createdAt    DateTime         @default(now())
  isActive     Boolean          @default(true)
  permissions  RolePermission[]
  users        UserRole[]

  @@map("roles")
}

model Permission {
  id          String              @id @default(uuid())
  description String?
  createdAt   DateTime            @default(now())
  isActive    Boolean             @default(true)
  group       String
  key         String              @unique
  label       String
  jobRoles    JobRolePermission[]
  roles       RolePermission[]
  users       UserPermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model UserPermission {
  userId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
  @@map("user_permissions")
}

model Request {
  id                 String               @id @default(uuid())
  readableId         String               @unique
  requesterUserId    String
  templateId         String?
  statusId           String
  currentStageTypeId String?
  departmentId       String
  unitId             String
  issueFromStoreId   String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  submittedAt        DateTime?
  assignments        RequestAssignment[]
  comments           RequestComment[]
  events             RequestEvent[]
  lines              RequestLine[]
  participants       RequestParticipant[]
  currentStageType   RequestStageType?    @relation(fields: [currentStageTypeId], references: [id])
  department         Department           @relation(fields: [departmentId], references: [id])
  issueFromStore     StoreLocation?       @relation(fields: [issueFromStoreId], references: [id])
  requester          User                 @relation("Requester", fields: [requesterUserId], references: [id])
  status             RequestStatus        @relation(fields: [statusId], references: [id])
  template           RequestTemplate?     @relation(fields: [templateId], references: [id])
  unit               Unit                 @relation(fields: [unitId], references: [id])
  reservations       Reservation[]

  @@index([statusId])
  @@index([requesterUserId])
  @@index([currentStageTypeId])
  @@map("requests")
}

model RequestLine {
  id          String       @id @default(uuid())
  requestId   String
  itemId      String
  quantity    Int
  item        Item         @relation(fields: [itemId], references: [id])
  request     Request      @relation(fields: [requestId], references: [id], onDelete: Cascade)
  reservation Reservation?

  @@index([requestId])
  @@map("request_lines")
}

model RequestAssignment {
  id           String            @id @default(uuid())
  requestId    String
  assignedToId String?
  stageTypeId  String?
  assignedById String?
  assignedAt   DateTime          @default(now())
  completedAt  DateTime?
  assignmentType AssignmentType    @default(USER)
  assignedRoleKey String?
  status         AssignmentStatus  @default(ACTIVE)
  assignedBy     User?             @relation("AssignedBy", fields: [assignedById], references: [id])
  assignedTo     User?             @relation("AssignedTo", fields: [assignedToId], references: [id])
  request        Request           @relation(fields: [requestId], references: [id], onDelete: Cascade)
  stageType      RequestStageType? @relation(fields: [stageTypeId], references: [id])

  @@index([requestId, status])
  @@index([assignedToId, status])
  @@map("request_assignments")
}

model RequestParticipant {
  id                    String              @id @default(uuid())
  requestId             String
  userId                String
  participantRoleTypeId String
  firstSeenAt           DateTime            @default(now())
  lastActionAt          DateTime            @updatedAt
  participantRoleType   ParticipantRoleType @relation(fields: [participantRoleTypeId], references: [id])
  request               Request             @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user                  User                @relation(fields: [userId], references: [id])

  @@unique([requestId, userId])
  @@index([userId])
  @@map("request_participants")
}

model RequestComment {
  id            String            @id @default(uuid())
  requestId     String
  authorId      String
  stageTypeId   String?
  commentTypeId String
  body          String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  author        User              @relation(fields: [authorId], references: [id])
  commentType   CommentType       @relation(fields: [commentTypeId], references: [id])
  request       Request           @relation(fields: [requestId], references: [id], onDelete: Cascade)
  stageType     RequestStageType? @relation(fields: [stageTypeId], references: [id])
  events        RequestEvent[]

  @@index([requestId, createdAt])
  @@map("request_comments")
}

model RequestEvent {
  id              String            @id @default(uuid())
  requestId       String
  eventTypeId     String
  actedByUserId   String?
  fromStatusId    String?
  toStatusId      String?
  fromStageTypeId String?
  toStageTypeId   String?
  commentId       String?
  metadata        String?
  createdAt       DateTime          @default(now())
  actedBy         User?             @relation(fields: [actedByUserId], references: [id])
  comment         RequestComment?   @relation(fields: [commentId], references: [id])
  eventType       RequestEventType  @relation(fields: [eventTypeId], references: [id])
  fromStageType   RequestStageType? @relation("FromStage", fields: [fromStageTypeId], references: [id])
  fromStatus      RequestStatus?    @relation("FromStatus", fields: [fromStatusId], references: [id])
  request         Request           @relation(fields: [requestId], references: [id], onDelete: Cascade)
  toStageType     RequestStageType? @relation("ToStage", fields: [toStageTypeId], references: [id])
  toStatus        RequestStatus?    @relation("ToStatus", fields: [toStatusId], references: [id])

  @@index([requestId, createdAt])
  @@map("request_events")
}

model RequestTemplate {
  id            String                 @id @default(uuid())
  name          String
  description   String?
  isActive      Boolean                @default(true)
  isDefault     Boolean                @default(false)
  createdById   String
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  createdBy     User                   @relation(fields: [createdById], references: [id])
  requests      Request[]
  templateLines TemplateRequestLine[]
  workflowSteps TemplateWorkflowStep[]

  @@map("request_templates")
}

model TemplateWorkflowStep {
  id           String           @id @default(uuid())
  templateId   String
  stageTypeId  String
  departmentId String?
  unitId       String?
  jobRoleId    String?
  stepOrder                  Int
  isRequired                 Boolean          @default(true)
  assignmentMode             AssignmentMode   @default(AUTO_POOL)
  roleKey                    String
  includeRequesterDepartment Boolean          @default(false)
  minApprovers               Int              @default(1)
  maxApprovers               Int              @default(1)
  requireAll                 Boolean          @default(false)
  allowRequesterSelect       Boolean          @default(false)
  branchId                   String?
  branch                     Branch?          @relation(fields: [branchId], references: [id])
  department                 Department?      @relation(fields: [departmentId], references: [id])
  jobRole                    JobRole?         @relation(fields: [jobRoleId], references: [id])
  stageType                  RequestStageType @relation(fields: [stageTypeId], references: [id])
  template                   RequestTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  unit                       Unit?            @relation(fields: [unitId], references: [id])
  specificUsers              TemplateStepSpecificUser[]

  @@unique([templateId, stepOrder])
  @@index([templateId])
  @@map("template_workflow_steps")
}

model TemplateStepSpecificUser {
  id     String               @id @default(uuid())
  stepId String
  userId String
  step   TemplateWorkflowStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  user   User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([stepId, userId])
  @@map("template_step_specific_users")
}

model TemplateRequestLine {
  id         String          @id @default(uuid())
  templateId String
  itemId     String
  quantity   Int
  item       Item            @relation(fields: [itemId], references: [id])
  template   RequestTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("template_request_lines")
}

model Category {
  id               String     @id @default(uuid())
  name             String     @unique
  description      String?
  parentCategoryId String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  isActive         Boolean    @default(true)
  parentCategory   Category?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories  Category[] @relation("CategoryHierarchy")
  items            Item[]

  @@map("categories")
}

model Item {
  id              String                @id @default(uuid())
  code            String                @unique
  name            String
  description     String?
  categoryId      String
  unitOfMeasure   String
  statusId        String
  reorderLevel    Int?
  reorderQuantity Int?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  forecastResults ForecastResult[]
  ledgerEntries   InventoryLedger[]
  category        Category              @relation(fields: [categoryId], references: [id])
  status          ItemStatus            @relation(fields: [statusId], references: [id])
  requestLines    RequestLine[]
  stockSnapshots  StockSnapshot[]
  stocktakeLines  StocktakeLine[]
  templateLines   TemplateRequestLine[]

  @@index([categoryId])
  @@index([statusId])
  @@map("items")
}

model StockSnapshot {
  itemId           String
  storeLocationId  String
  quantityOnHand   Int
  reservedQuantity Int           @default(0)
  lastUpdatedAt    DateTime      @updatedAt
  reservations     Reservation[]
  item             Item          @relation(fields: [itemId], references: [id])
  storeLocation    StoreLocation @relation(fields: [storeLocationId], references: [id])

  @@id([itemId, storeLocationId])
  @@index([storeLocationId])
  @@map("stock_snapshots")
}

model Reservation {
  id              String        @id @default(uuid())
  requestLineId   String        @unique
  itemId          String
  storeLocationId String
  quantity        Int
  createdAt       DateTime      @default(now())
  requestId       String?
  stockSnapshot   StockSnapshot @relation(fields: [itemId, storeLocationId], references: [itemId, storeLocationId])
  request         Request?      @relation(fields: [requestId], references: [id])
  requestLine     RequestLine   @relation(fields: [requestLineId], references: [id], onDelete: Cascade)

  @@index([itemId, storeLocationId])
  @@map("reservations")
}

model ReasonCode {
  id                String                   @id @default(uuid())
  code              String                   @unique
  name              String
  description       String?
  isActive          Boolean                  @default(true)
  requiresFreeText  Boolean                  @default(false)
  requiresApproval  Boolean                  @default(false)
  approvalThreshold Float?
  label             String?
  createdAt         DateTime                 @default(now())
  ledgerEntries     InventoryLedger[]
  allowedMovements  ReasonCodeMovementType[]

  @@index([isActive])
  @@map("reason_codes")
}

model ReasonCodeMovementType {
  reasonCodeId         String
  ledgerMovementTypeId String
  ledgerMovementType   LedgerMovementType @relation(fields: [ledgerMovementTypeId], references: [id], onDelete: Cascade)
  reasonCode           ReasonCode         @relation(fields: [reasonCodeId], references: [id], onDelete: Cascade)

  @@id([reasonCodeId, ledgerMovementTypeId])
  @@map("reason_code_movement_types")
}

model InventoryLedger {
  id                   String             @id @default(uuid())
  itemId               String
  fromStoreLocationId  String?
  toStoreLocationId    String?
  movementTypeId       String
  quantity             Int
  unitOfMeasure        String
  reasonCodeId         String
  reasonText           String?
  referenceNo          String?
  department           String?
  useBy                String?
  suppliedBy           String?
  receivedBy           String?
  comments             String?
  createdByUserId      String
  createdAtUtc         DateTime           @default(now())
  source               String             @default("UI")
  importJobId          String?
  correctionOfLedgerId String?
  reversalOfLedgerId   String?
  unitCost             Float?
  totalCost            Float?
  correctionOfLedger   InventoryLedger?   @relation("Corrections", fields: [correctionOfLedgerId], references: [id])
  corrections          InventoryLedger[]  @relation("Corrections")
  createdBy            User               @relation("CreatedBy", fields: [createdByUserId], references: [id])
  fromStoreLocation    StoreLocation?     @relation("FromStoreLocation", fields: [fromStoreLocationId], references: [id])
  importJob            ImportJob?         @relation(fields: [importJobId], references: [id])
  item                 Item               @relation(fields: [itemId], references: [id])
  movementType         LedgerMovementType @relation(fields: [movementTypeId], references: [id])
  reasonCode           ReasonCode         @relation(fields: [reasonCodeId], references: [id])
  reversalOfLedger     InventoryLedger?   @relation("Reversals", fields: [reversalOfLedgerId], references: [id])
  reversals            InventoryLedger[]  @relation("Reversals")
  toStoreLocation      StoreLocation?     @relation("ToStoreLocation", fields: [toStoreLocationId], references: [id])

  @@index([itemId])
  @@index([fromStoreLocationId])
  @@index([toStoreLocationId])
  @@index([movementTypeId])
  @@index([createdAtUtc])
  @@index([importJobId])
  @@map("inventory_ledger")
}

model Stocktake {
  id               String          @id @default(uuid())
  name             String
  storeLocationId  String
  statusId         String
  startedAt        DateTime?
  completedAt      DateTime?
  createdByUserId  String
  createdAt        DateTime        @default(now())
  approvedByUserId String?
  approvedAt       DateTime?
  lines            StocktakeLine[]
  approvedBy       User?           @relation("StocktakeApprover", fields: [approvedByUserId], references: [id])
  createdBy        User            @relation(fields: [createdByUserId], references: [id])
  status           StocktakeStatus @relation(fields: [statusId], references: [id])
  storeLocation    StoreLocation   @relation(fields: [storeLocationId], references: [id])

  @@index([storeLocationId])
  @@index([statusId])
  @@map("stocktakes")
}

model StocktakeLine {
  id              String    @id @default(uuid())
  stocktakeId     String
  itemId          String
  systemQuantity  Int
  countedQuantity Int?
  variance        Int?
  notes           String?
  item            Item      @relation(fields: [itemId], references: [id])
  stocktake       Stocktake @relation(fields: [stocktakeId], references: [id], onDelete: Cascade)

  @@index([stocktakeId])
  @@index([itemId])
  @@map("stocktake_lines")
}

model SystemSequence {
  id        String   @id @default(uuid())
  name      String
  year      Int
  nextValue Int
  updatedAt DateTime @updatedAt

  @@unique([name, year])
  @@map("system_sequences")
}

model ImportJob {
  id              String            @id @default(uuid())
  filename        String
  fileHash        String
  status          String            @default("PENDING")
  totalRows       Int               @default(0)
  processedRows   Int               @default(0)
  errorRows       Int               @default(0)
  errorReportPath String?
  createdByUserId String
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime          @default(now())
  errors          ImportError[]
  createdBy       User              @relation(fields: [createdByUserId], references: [id])
  ledgerEntries   InventoryLedger[]

  @@index([status])
  @@index([createdAt])
  @@map("import_jobs")
}

model ImportError {
  id           String    @id @default(uuid())
  importJobId  String
  rowNumber    Int
  sheetName    String
  fieldName    String?
  errorMessage String
  importJob    ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)

  @@index([importJobId])
  @@map("import_errors")
}

model ForecastRun {
  id              String           @id @default(uuid())
  name            String
  method          String
  periodMonths    Int
  runAt           DateTime         @default(now())
  createdByUserId String
  results         ForecastResult[]
  createdBy       User             @relation(fields: [createdByUserId], references: [id])

  @@index([runAt])
  @@map("forecast_runs")
}

model ForecastResult {
  id                   String        @id @default(uuid())
  forecastRunId        String
  itemId               String
  storeLocationId      String
  predictedConsumption Int
  currentStock         Int
  reorderSuggestion    Int
  forecastRun          ForecastRun   @relation(fields: [forecastRunId], references: [id], onDelete: Cascade)
  item                 Item          @relation(fields: [itemId], references: [id])
  storeLocation        StoreLocation @relation(fields: [storeLocationId], references: [id])

  @@index([forecastRunId])
  @@index([itemId])
  @@index([storeLocationId])
  @@map("forecast_results")
}

model BrandingSettings {
  id              String   @id @default(uuid())
  logoUrl         String?
  primaryColor    String   @default("#3b82f6")
  secondaryColor  String   @default("#8b5cf6")
  updatedAt       DateTime @updatedAt
  updatedByUserId String
  updatedBy       User     @relation(fields: [updatedByUserId], references: [id])

  @@map("branding_settings")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?
  action       String
  resourceType String
  resourceId   String?
  changesJson  String?
  ipAddress    String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resourceType])
  @@index([createdAt])
  @@map("audit_logs")
}

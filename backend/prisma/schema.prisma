// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// RBAC
model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  name      String?
  roles     UserRole[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  ledgerEntries  InventoryLedger[]
  auditLogs      AuditLog[]
  importJobs     ImportJob[]
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  permissions RolePermission[]
  users       UserRole[]
}

model Permission {
  id          String           @id @default(uuid())
  action      String           @unique // e.g., 'item.create', 'ledger.view'
  description String?
  roles       RolePermission[]
}

model UserRole {
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId String

  @@id([userId, roleId])
}

model RolePermission {
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  roleId       String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  permissionId String

  @@id([roleId, permissionId])
}

// Inventory Master Data
model Item {
  id                String  @id @default(uuid())
  sku               String  @unique // ITEM NO.
  name              String  @unique // ITEM NAME
  description       String? // INVENTORY DESCRIPTION
  uom               UnitOfMeasure @relation(fields: [uomId], references: [id])
  uomId             String
  category          Category?     @relation(fields: [categoryId], references: [id])
  categoryId        String?
  discontinued      Boolean       @default(false)
  
  // Reorder config
  reorderLevel      Float @default(0)
  reorderQuantity   Float @default(0)

  ledgerEntries     InventoryLedger[]
  snapshots         StockSnapshot[]
  stocktakeLines    StocktakeLine[]
  forecastResults   ForecastResult[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([sku])
  @@index([name])
}

model Category {
  id    String @id @default(uuid())
  name  String @unique
  items Item[]
}

model UnitOfMeasure {
  id    String @id @default(uuid())
  name  String @unique
  items Item[]
}

enum LocationType {
  STORE
  WAREHOUSE
  DEPARTMENT
}

model Location {
  id          String       @id @default(uuid())
  name        String       @unique
  type        LocationType @default(STORE)
  description String?

  snapshots         StockSnapshot[]
  ledgersFrom       InventoryLedger[] @relation("FromLocation")
  ledgersTo         InventoryLedger[] @relation("ToLocation")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model ReasonCode {
  id            String @id @default(uuid())
  code          String @unique
  description   String
  ledgerEntries InventoryLedger[]
}

// Append-only Ledger
enum MovementType {
  RECEIVE
  ISSUE
  TRANSFER
  ADJUSTMENT
}

model InventoryLedger {
  id                String       @id @default(uuid())
  item              Item         @relation(fields: [itemId], references: [id])
  itemId            String
  fromLocation      Location?    @relation("FromLocation", fields: [fromLocationId], references: [id])
  fromLocationId    String?
  toLocation        Location?    @relation("ToLocation", fields: [toLocationId], references: [id])
  toLocationId      String?
  movementType      MovementType
  quantity          Float
  
  reasonCode        ReasonCode   @relation(fields: [reasonCodeId], references: [id])
  reasonCodeId      String
  reasonText        String?
  
  referenceNo       String? // requisition/grn
  department        String?
  useBy             String?
  suppliedBy        String?
  receivedBy        String?
  comments          String?
  
  source            String       @default("UI") // UI, API, IMPORT
  importJobId       String?
  
  correctionOfId    String?      @unique
  correctionOf      InventoryLedger? @relation("Correction", fields: [correctionOfId], references: [id])
  correctedBy       InventoryLedger? @relation("Correction")

  createdBy         User         @relation(fields: [createdById], references: [id])
  createdById       String
  createdAt         DateTime     @default(now()) // UTC

  @@index([itemId, createdAt])
  @@index([fromLocationId, createdAt])
  @@index([toLocationId, createdAt])
  @@index([movementType, createdAt])
}

// Materialized Stock Snapshot
model StockSnapshot {
  id         String   @id @default(uuid())
  item       Item     @relation(fields: [itemId], references: [id])
  itemId     String
  location   Location @relation(fields: [locationId], references: [id])
  locationId String
  quantity   Float    @default(0)
  updatedAt  DateTime @updatedAt

  @@unique([itemId, locationId])
  @@index([itemId, locationId])
}

// Stocktake
model Stocktake {
  id          String          @id @default(uuid())
  name        String
  status      String          @default("OPEN") // OPEN, CLOSED
  lines       StocktakeLine[]
  createdAt   DateTime        @default(now())
  completedAt DateTime?
}

model StocktakeLine {
  id          String    @id @default(uuid())
  stocktake   Stocktake @relation(fields: [stocktakeId], references: [id])
  stocktakeId String
  item        Item      @relation(fields: [itemId], references: [id])
  itemId      String
  expectedQty Float
  countedQty  Float
  variance    Float
  
  createdAt   DateTime  @default(now())
}

// Audit & System
model AuditLog {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  action    String
  entity    String
  entityId  String
  details   Json?
  createdAt DateTime @default(now())
}

model BrandingSettings {
  id           String @id @default("1") // Singleton
  logoUrl      String?
  primaryColor String @default("#3b82f6")
  darkLogoUrl  String?
  themeTokens  Json?
}

model ImportJob {
  id           String   @id @default(uuid())
  filename     String
  fileHash     String?
  status       String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  errorLog     Json?
  rowCount     Int      @default(0)
  processedAt  DateTime?
  user         User     @relation(fields: [userId], references: [id])
  userId       String
  createdAt    DateTime @default(now())
}

model ForecastResult {
  id                String   @id @default(uuid())
  item              Item     @relation(fields: [itemId], references: [id])
  itemId            String
  period            String   // e.g. "2025-02"
  forecastQty       Float
  recommendedOrder  Float
  method            String   // MOVING_AVERAGE, EXP_SMOOTHING
  createdAt         DateTime @default(now())

  @@unique([itemId, period])
}

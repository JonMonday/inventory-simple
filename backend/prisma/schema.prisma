generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id                  String              @id @default(uuid())
  email               String              @unique
  passwordHash        String
  fullName            String
  departmentId        String?
  locationId          String?
  mustChangePassword  Boolean             @default(false)
  isActive            Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  auditLogs           AuditLog[]
  brandingUpdates     BrandingSettings[]
  createdForecastRuns ForecastRun[]
  createdImportJobs   ImportJob[]
  createdLedgers      InventoryLedger[]   @relation("CreatedBy")
  requestsAssigned    RequestAssignment[]
  requestEvents       RequestEvent[]
  requestsCreated     Request[]           @relation("Requester")
  approvedStocktakes  Stocktake[]         @relation("StocktakeApprover")
  createdStocktakes   Stocktake[]
  permissions         UserPermission[]
  assignedRoles       UserRole[]          @relation("AssignedBy")
  roles               UserRole[]
  location            Location?           @relation("UserLocation", fields: [locationId], references: [id])
  department          Location?           @relation("UserDepartment", fields: [departmentId], references: [id])

  branchId            String?
  branch              Branch?             @relation(fields: [branchId], references: [id])

  @@map("users")
}

model Role {
  id           String           @id @default(uuid())
  name         String           @unique
  description  String?
  isSystemRole Boolean          @default(false)
  createdAt    DateTime         @default(now())
  permissions  RolePermission[]
  users        UserRole[]

  @@map("roles")
}

model Permission {
  id          String           @id @default(uuid())
  resource    String
  action      String
  description String?
  createdAt   DateTime         @default(now())
  roles       RolePermission[]
  users       UserPermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  userId       String
  roleId       String
  assignedAt   DateTime @default(now())
  assignedById String?
  assignedBy   User?    @relation("AssignedBy", fields: [assignedById], references: [id])
  role         Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model UserPermission {
  userId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, permissionId])
  @@map("user_permissions")
}

model Category {
  id               String     @id @default(uuid())
  name             String     @unique
  description      String?
  parentCategoryId String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  parentCategory   Category?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories  Category[] @relation("CategoryHierarchy")
  items            Item[]

  @@map("categories")
}

model Item {
  id              String            @id @default(uuid())
  code            String            @unique
  name            String
  description     String?
  categoryId      String
  unitOfMeasure   String
  status          String            @default("ACTIVE")
  reorderLevel    Int?
  reorderQuantity Int?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  forecastResults ForecastResult[]
  ledgerEntries   InventoryLedger[]
  category        Category          @relation(fields: [categoryId], references: [id])
  requestLines    RequestLine[]
  stockSnapshots  StockSnapshot[]
  stocktakeLines  StocktakeLine[]

  @@index([categoryId])
  @@index([status])
  @@map("items")
}

model Location {
  id                String            @id @default(uuid())
  code              String            @unique
  name              String
  type              String
  parentLocationId  String?
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  forecastResults   ForecastResult[]
  ledgerEntriesTo   InventoryLedger[] @relation("ToLocation")
  ledgerEntriesFrom InventoryLedger[] @relation("FromLocation")
  parentLocation    Location?         @relation("LocationHierarchy", fields: [parentLocationId], references: [id])
  childLocations    Location[]        @relation("LocationHierarchy")
  requestsFulfilled Request[]         @relation("RequestIssueFrom")
  requestsAsLoc     Request[]         @relation("RequestLocation")
  requestsAsDept    Request[]         @relation("RequestDepartment")
  stockSnapshots    StockSnapshot[]
  stocktakes        Stocktake[]
  usersInLocation   User[]            @relation("UserLocation")
  usersInDepartment User[]            @relation("UserDepartment")

  branchId          String
  branch            Branch            @relation(fields: [branchId], references: [id])

  @@index([type])
  @@index([isActive])
  @@map("locations")
}

model ReasonCode {
  id               String                   @id @default(uuid())
  code             String                   @unique
  name             String
  description      String?
  isActive         Boolean                  @default(true)
  requiresFreeText Boolean                  @default(false)
  requiresApproval Boolean                  @default(false)
  approvalThreshold Float?
  label            String?
  createdAt        DateTime                 @default(now())
  ledgerEntries    InventoryLedger[]
  allowedMovements ReasonCodeMovementType[]

  @@index([isActive])
  @@map("reason_codes")
}

model ReasonCodeMovementType {
  reasonCodeId String
  movementType String
  reasonCode   ReasonCode @relation(fields: [reasonCodeId], references: [id], onDelete: Cascade)

  @@id([reasonCodeId, movementType])
  @@map("reason_code_movement_types")
}

model Branch {
  id        String     @id @default(uuid())
  code      String     @unique
  name      String
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  locations Location[]
  users     User[]

  @@map("branches")
}

model InventoryLedger {
  id                   String            @id @default(uuid())
  itemId               String
  fromLocationId       String?
  toLocationId         String?
  movementType         String
  quantity             Int
  unitOfMeasure        String
  reasonCodeId         String
  reasonText           String?
  referenceNo          String?
  department           String?
  useBy                String?
  suppliedBy           String?
  receivedBy           String?
  comments             String?
  createdByUserId      String
  createdAtUtc         DateTime          @default(now())
  source               String            @default("UI")
  importJobId          String?
  correctionOfLedgerId String?
  reversalOfLedgerId   String?
  unitCost             Float?
  totalCost            Float?
  reversalOfLedger     InventoryLedger?  @relation("Reversals", fields: [reversalOfLedgerId], references: [id])
  reversals            InventoryLedger[] @relation("Reversals")
  correctionOfLedger   InventoryLedger?  @relation("Corrections", fields: [correctionOfLedgerId], references: [id])
  corrections          InventoryLedger[] @relation("Corrections")
  importJob            ImportJob?        @relation(fields: [importJobId], references: [id])
  createdBy            User              @relation("CreatedBy", fields: [createdByUserId], references: [id])
  reasonCode           ReasonCode        @relation(fields: [reasonCodeId], references: [id])
  toLocation           Location?         @relation("ToLocation", fields: [toLocationId], references: [id])
  fromLocation         Location?         @relation("FromLocation", fields: [fromLocationId], references: [id])
  item                 Item              @relation(fields: [itemId], references: [id])

  @@index([itemId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([movementType])
  @@index([createdAtUtc])
  @@index([importJobId])
  @@map("inventory_ledger")
}

model StockSnapshot {
  itemId           String
  locationId       String
  quantityOnHand   Int
  reservedQuantity Int           @default(0)
  lastUpdatedAt    DateTime      @updatedAt
  reservations     Reservation[]
  location         Location      @relation(fields: [locationId], references: [id])
  item             Item          @relation(fields: [itemId], references: [id])

  @@id([itemId, locationId])
  @@index([locationId])
  @@map("stock_snapshots")
}

model Reservation {
  id            String        @id @default(uuid())
  requestLineId String        @unique
  itemId        String
  locationId    String
  quantity      Int
  createdAt     DateTime      @default(now())
  requestLine   RequestLine   @relation(fields: [requestLineId], references: [id], onDelete: Cascade)
  stockSnapshot StockSnapshot @relation(fields: [itemId, locationId], references: [itemId, locationId])

  @@index([itemId, locationId])
  @@map("reservations")
}

model SystemSequence {
  id        String   @id @default(uuid())
  name      String
  year      Int
  nextValue Int
  updatedAt DateTime @updatedAt

  @@unique([name, year])
  @@map("system_sequences")
}

model Request {
  id                  String              @id @default(uuid())
  readableId          String              @unique
  requesterUserId     String
  status              String              @default("DRAFT")
  departmentId        String?
  locationId          String?
  issueFromLocationId String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  assignments         RequestAssignment[]
  events              RequestEvent[]
  lines               RequestLine[]
  issueFrom           Location?           @relation("RequestIssueFrom", fields: [issueFromLocationId], references: [id])
  location            Location?           @relation("RequestLocation", fields: [locationId], references: [id])
  department          Location?           @relation("RequestDepartment", fields: [departmentId], references: [id])
  requester           User                @relation("Requester", fields: [requesterUserId], references: [id])

  @@index([status])
  @@index([requesterUserId])
  @@map("requests")
}

model RequestLine {
  id          String       @id @default(uuid())
  requestId   String
  itemId      String
  quantity    Int
  item        Item         @relation(fields: [itemId], references: [id])
  request     Request      @relation(fields: [requestId], references: [id], onDelete: Cascade)
  reservation Reservation?

  @@index([requestId])
  @@map("request_lines")
}

model RequestAssignment {
  id          String    @id @default(uuid())
  requestId   String
  userId      String
  level       String
  isActive    Boolean   @default(true)
  assignedAt  DateTime  @default(now())
  completedAt DateTime?
  user        User      @relation(fields: [userId], references: [id])
  request     Request   @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([userId])
  @@map("request_assignments")
}

model RequestEvent {
  id          String   @id @default(uuid())
  requestId   String
  userId      String?
  type        String
  description String
  dataJson    String?
  createdAt   DateTime @default(now())
  user        User?    @relation(fields: [userId], references: [id])
  request     Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("request_events")
}

model Stocktake {
  id               String          @id @default(uuid())
  name             String
  locationId       String
  status           String          @default("DRAFT")
  startedAt        DateTime?
  completedAt      DateTime?
  createdByUserId  String
  createdAt        DateTime        @default(now())
  approvedByUserId String?
  approvedAt       DateTime?
  lines            StocktakeLine[]
  approvedBy       User?           @relation("StocktakeApprover", fields: [approvedByUserId], references: [id])
  createdBy        User            @relation(fields: [createdByUserId], references: [id])
  location         Location        @relation(fields: [locationId], references: [id])

  @@index([locationId])
  @@index([status])
  @@map("stocktakes")
}

model StocktakeLine {
  id              String    @id @default(uuid())
  stocktakeId     String
  itemId          String
  systemQuantity  Int
  countedQuantity Int?
  variance        Int?
  notes           String?
  item            Item      @relation(fields: [itemId], references: [id])
  stocktake       Stocktake @relation(fields: [stocktakeId], references: [id], onDelete: Cascade)

  @@index([stocktakeId])
  @@index([itemId])
  @@map("stocktake_lines")
}

model ImportJob {
  id              String            @id @default(uuid())
  filename        String
  fileHash        String
  status          String            @default("PENDING")
  totalRows       Int               @default(0)
  processedRows   Int               @default(0)
  errorRows       Int               @default(0)
  errorReportPath String?
  createdByUserId String
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime          @default(now())
  errors          ImportError[]
  createdBy       User              @relation(fields: [createdByUserId], references: [id])
  ledgerEntries   InventoryLedger[]

  @@index([status])
  @@index([createdAt])
  @@map("import_jobs")
}

model ImportError {
  id           String    @id @default(uuid())
  importJobId  String
  rowNumber    Int
  sheetName    String
  fieldName    String?
  errorMessage String
  importJob    ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)

  @@index([importJobId])
  @@map("import_errors")
}

model ForecastRun {
  id              String           @id @default(uuid())
  name            String
  method          String
  periodMonths    Int
  runAt           DateTime         @default(now())
  createdByUserId String
  results         ForecastResult[]
  createdBy       User             @relation(fields: [createdByUserId], references: [id])

  @@index([runAt])
  @@map("forecast_runs")
}

model ForecastResult {
  id                   String      @id @default(uuid())
  forecastRunId        String
  itemId               String
  locationId           String
  predictedConsumption Int
  currentStock         Int
  reorderSuggestion    Int
  location             Location    @relation(fields: [locationId], references: [id])
  item                 Item        @relation(fields: [itemId], references: [id])
  forecastRun          ForecastRun @relation(fields: [forecastRunId], references: [id], onDelete: Cascade)

  @@index([forecastRunId])
  @@index([itemId])
  @@index([locationId])
  @@map("forecast_results")
}

model BrandingSettings {
  id              String   @id @default(uuid())
  logoUrl         String?
  primaryColor    String   @default("#3b82f6")
  secondaryColor  String   @default("#8b5cf6")
  updatedAt       DateTime @updatedAt
  updatedByUserId String
  updatedBy       User     @relation(fields: [updatedByUserId], references: [id])

  @@map("branding_settings")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?
  action       String
  resourceType String
  resourceId   String?
  changesJson  String?
  ipAddress    String?
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resourceType])
  @@index([createdAt])
  @@map("audit_logs")
}
